name: "CodeQL"

on:
  workflow_dispatch:
  push:
    branches: [ armlab ]
  pull_request:
    branches: [ armlab ]

jobs:
  analyze:
    name: Analyze

    runs-on: Arm-Virtual-Hardware

    env:
      CMSIS_PACK_ROOT: /tmp/.packs-${{ github.run_id }}
      AC6_TOOLCHAIN_6_18_0: /opt/armcompiler/bin
      GCC_TOOLCHAIN_11_2_0: /opt/gcc-arm-11.2-2022.02-x86_64-arm-none-eabi/bin
      LD_LIBRARY_PATH: /opt/VHT
      ARMLMD_LICENSE_FILE: /opt/data.dat
      ARMCOMPILER6_CLANGOPT: -Wno-license-management
      ARMCOMPILER6_LINKOPT: --diag_suppress=9931
      ARMCOMPILER6_FROMELFOPT: --diag_suppress=9931
      ARMCOMPILER6_ASMOPT: --diag_suppress=9931

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Checkout CMSIS repository
      uses: actions/checkout@v3
      with:
        repository: ARM-software/CMSIS_5
        ref: develop
        path: CMSIS_5

    - name: Install CMake
      run: |
        wget https://github.com/Kitware/CMake/releases/download/v3.25.1/cmake-3.25.1-linux-x86_64.tar.gz
        tar -xf cmake-3.25.1-linux-x86_64.tar.gz
        sudo mv cmake-3.25.1-linux-x86_64 /opt/cmake-3.25.1
        sudo ln -s /opt/cmake-3.25.1/bin/cmake /usr/local/bin/cmake

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip' # caching pip dependencies

    - name: Cache pack folder
      id: cache-packs
      uses: actions/cache@v3
      with:
        key: packs-${{ github.run_id }}
        restore-keys: |
          packs-
        path: /tmp/.packs-${{ github.run_id }}

    - name: Install CMSIS-Toolbox
      run: |
        wget https://github.com/Open-CMSIS-Pack/cmsis-toolbox/releases/download/1.5.0/cmsis-toolbox-linux-amd64.tar.gz
        tar -C /opt -xf cmsis-toolbox-linux-amd64.tar.gz
        echo "/opt/cmsis-toolbox-linux-amd64/bin" >> $GITHUB_PATH

    - name: Initialize packs folder
      if: steps.cache-packs.outputs.cache-hit != 'true'
      run: cpackget init https://www.keil.com/pack/index.pidx

    - name: Update pack index
      if: steps.cache-packs.outputs.cache-hit == 'true'
      run: cpackget update-index

    - name: Register local CMSIS pack
      run: |
        mkdir -p ${CMSIS_PACK_ROOT}/.Local
        cat > ${CMSIS_PACK_ROOT}/.Local/local_repository.pidx <<EOF
        <?xml version="1.0" encoding="UTF-8" standalone="no" ?>
        <index schemaVersion="1.1.0" xmlns:xs="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xs:noNamespaceSchemaLocation="PackIndex.xsd">
          <vendor>local repository</vendor>
          <url>file://localhost/${CMSIS_PACK_ROOT}</url>
          <timestamp>2022-12-19T11:18:37</timestamp>
          <pindex>
            <pdsc vendor="ARM" name="CMSIS" url="file://localhost/${GITHUB_WORKSPACE}/CMSIS_5" version="5.9.1"/>
          </pindex>
        </index>
        EOF

    - name: Install build.py requirements
      run: pip install -r requirements.txt
      working-directory: Project

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: cpp
        queries: security-and-quality

    - name: Build projects
      working-directory: Project
      run: |
        python build.py --verbose -c GCC -r RTX5 -d CM3 build

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2

    - name: Archive sarif report
      uses: actions/upload-artifact@v3
      with:
        path: /home/root/work/CMSIS-RTOS2_Validation/results/cpp.sarif
        retention-days: 1
        if-no-files-found: error
      if: always()
